<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium SGPA Calculator Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --accent: #f72585;
            --success: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --bg-light: #ffffff;
            --bg-dark: #121212;
            --card-light: rgba(255, 255, 255, 0.85);
            --card-dark: rgba(30, 30, 30, 0.85);
            --text-light: #333333;
            --text-dark: #f0f0f0;
            --border-light: rgba(224, 224, 224, 0.5);
            --border-dark: rgba(51, 51, 51, 0.5);
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
            --transition: all 0.3s ease;
            --border-radius: 16px;
            --glow: 0 0 15px rgba(67, 97, 238, 0.3);
            --glass: rgba(255, 255, 255, 0.15);
            --glass-dark: rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f0f5ff 0%, #e6edff 100%);
            color: var(--text-light);
            min-height: 100vh;
            transition: var(--transition);
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            backdrop-filter: blur(20px);
        }

        body.dark-mode {
            background: linear-gradient(135deg, #0c0e2b 0%, #1a1a40 100%);
            color: var(--text-dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .bg-blob {
            position: absolute;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.1;
            z-index: 1;
            animation: float 15s infinite ease-in-out;
        }

        .blob-1 {
            background: var(--primary);
            top: 10%;
            right: -10%;
        }

        .blob-2 {
            background: var(--accent);
            bottom: 10%;
            left: -10%;
        }

        @keyframes float {
            0% { transform: translate(0, 0); }
            50% { transform: translate(-20px, 20px); }
            100% { transform: translate(0, 0); }
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            width: 50px;
            height: 50px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: var(--shadow);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.4); }
            70% { transform: scale(1.03); box-shadow: 0 0 0 15px rgba(67, 97, 238, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
        }

        .logo-text {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .theme-toggle {
            background: var(--bg-light);
            border: 1px solid var(--border-light);
            width: 60px;
            height: 30px;
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        body.dark-mode .theme-toggle {
            background: var(--bg-dark);
            border-color: var(--border-dark);
        }

        .theme-toggle::before {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            top: 2px;
            left: 3px;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        body.dark-mode .theme-toggle::before {
            left: 32px;
            background: var(--success);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .card {
            background: var(--card-light);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            transition: var(--transition);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
            z-index: 2;
        }

        body.dark-mode .card {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
        }

        body.dark-mode .card-header {
            border-bottom-color: var(--border-dark);
        }

        .card-title {
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--primary);
        }

        .tabs {
            display: flex;
            background: #f0f2f5;
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 25px;
            position: relative;
        }

        body.dark-mode .tabs {
            background: #2a2a2a;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            position: relative;
            z-index: 2;
        }

        .tab.active {
            color: white;
        }

        .tab.active::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
            z-index: -1;
            box-shadow: var(--glow);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-content.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 15px;
        }

        body.dark-mode label {
            color: var(--text-dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            background: var(--bg-light);
            color: var(--text-light);
            font-size: 16px;
            transition: var(--transition);
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background: var(--card-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .add-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: var(--transition);
            width: 100%;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .add-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: 0.5s;
            z-index: -1;
        }

        .add-btn:hover::before {
            left: 100%;
        }

        .add-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
        }

        .result-container {
            margin-top: 30px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        th, td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        body.dark-mode th,
        body.dark-mode td {
            border-bottom-color: var(--border-dark);
        }

        th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background: rgba(67, 97, 238, 0.05);
        }

        body.dark-mode tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.05);
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
            padding: 5px;
            border-radius: 6px;
        }

        .action-btn:hover {
            background: rgba(67, 97, 238, 0.1);
        }

        .sgpa-display {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .sgpa-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(255,255,255,0.15) 0%, transparent 70%);
        }

        .sgpa-label {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
        }

        .sgpa-value {
            font-size: 48px;
            font-weight: 800;
            margin: 10px 0;
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.5s ease;
        }
        /* Custom SGPA value colors for light mode */
        body:not(.dark-mode) .sgpa-value {
            color: var(--text-dark); /* Ensure it's visible in light mode */
        }


        @keyframes pulse-sgpa {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .sgpa-scale {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 2;
        }

        .chart-container {
            height: 250px;
            margin-top: 20px;
            position: relative;
            z-index: 2;
        }

        .export-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }

        @media (max-width: 600px) {
            .export-actions {
                grid-template-columns: 1fr;
            }
        }

        .export-btn {
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .export-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255,255,255,0.3), transparent);
            opacity: 0;
            transition: var(--transition);
        }

        .export-btn:hover::before {
            opacity: 1;
        }

        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .export-btn.pdf {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .export-btn.csv {
            background: linear-gradient(135deg, #4cc9f0, #6bd6ff);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 201, 240, 0.3);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px;
            margin-top: 30px; /* Increased margin-top for better spacing */
            padding: 0; 
        }
        /* Make the grid span the full width of its parent (.main-content) */
        .main-content .features-grid {
             width: 100%;
        }

        @media (min-width: 900px) { 
            .features-grid {
                grid-template-columns: repeat(4, 1fr); 
            }
        }


        .feature-card {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: var(--transition);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
        }

        body.dark-mode .feature-card {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .feature-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
        }

        .feature-text h3 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .feature-text p {
            font-size: 14px;
            color: #777;
        }

        body.dark-mode .feature-text p {
            color: #aaa;
        }

        footer {
            text-align: center;
            padding: 30px 0;
            margin-top: 30px;
            color: #777;
            border-top: 1px solid var(--border-light);
            font-size: 14px;
        }

        body.dark-mode footer {
            border-top-color: var(--border-dark);
            color: #aaa;
        }

        .status-bar {
            padding: 10px 15px;
            border-radius: 8px;
            background: rgba(76, 201, 240, 0.15);
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4cc9f0;
            font-weight: 500;
        }

        body.dark-mode .status-bar {
            background: rgba(76, 201, 240, 0.1);
        }

        .status-bar.error {
            background: rgba(255, 107, 107, 0.15);
            color: #ff6b6b;
        }

        body.dark-mode .status-bar.error {
            background: rgba(255, 107, 107, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #777;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ddd;
        }

        .highlight {
            animation: highlight 2s ease;
        }

        @keyframes highlight {
            0% { background: rgba(76, 201, 240, 0.3); }
            100% { background: transparent; }
        }

        @media (max-width: 600px) {
            .card {
                padding: 20px;
            }
            .logo-text {
                font-size: 22px;
            }
            .sgpa-value {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>
    
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="logo-text">SGPA Calculator Pro</div>
            </div>
            <div class="theme-toggle" id="themeToggle"></div>
        </header>
        
        <div class="dashboard">
            <div class="main-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-edit"></i> Enter Your Grades</h2>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" data-tab="manual">Manual Entry</div>
                        <div class="tab" data-tab="paste">Paste Results</div>
                    </div>
                    
                    <div class="tab-content manual active">
                        <div class="input-group">
                            <label for="subjectName">Subject Name</label>
                            <input type="text" id="subjectName" placeholder="Enter subject name">
                        </div>
                        
                        <div class="input-group">
                            <label for="credits">Credits</label>
                            <input type="number" id="credits" placeholder="Enter credits" min="1" max="10" value="4">
                        </div>
                        
                        <div class="input-group">
                            <label for="grade">Grade</label>
                            <select id="grade">
                                <option value="10">A+</option>
                                <option value="9">A</option>
                                <option value="8">B+</option>
                                <option value="7">B</option>
                                <option value="6">C+</option>
                                <option value="5">C</option>
                                <option value="4">D</option>
                                <option value="0">E/F/I</option>
                            </select>
                        </div>
                        
                        <button class="add-btn" id="addSubject">
                            <i class="fas fa-plus"></i> Add Subject
                        </button>
                    </div>
                    
                    <div class="tab-content paste">
                        <div class="input-group">
                            <label for="resultText">Paste Your Result Sheet</label>
                            <textarea id="resultText" rows="6" placeholder="Paste your result sheet text here..."></textarea>
                        </div>
                        
                        <button class="add-btn" id="parseResults">
                            <i class="fas fa-magic"></i> Parse Results
                        </button>
                        
                        <div id="parseStatus" class="status-bar" style="display: none;">
                            <i class="fas fa-sync fa-spin"></i>
                            <span>Processing your results...</span>
                        </div>
                    </div>
                    
                    <div class="result-container">
                        <div class="result-header">
                            <h3 class="card-title"><i class="fas fa-table"></i> Results</h3>
                            <button class="action-btn" id="resetBtn" title="Reset all data">
                                <i class="fas fa-trash-alt"></i> Reset
                            </button>
                        </div>
                        
                        <table id="resultTable">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Credits</th>
                                    <th>Grade</th>
                                    <th>Points</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="resultBody">
                                <!-- Results will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="feature-text">
                            <h3>Advanced Parsing</h3>
                            <p>Intelligent result sheet extraction</p>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="feature-text">
                            <h3>Data Persistence</h3>
                            <p>Auto-saves your data between sessions</p>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-rocket"></i>
                        </div>
                        <div class="feature-text">
                            <h3>Fast Processing</h3>
                            <p>Optimized for large result sheets</p>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-file-export"></i>
                        </div>
                        <div class="feature-text">
                            <h3>Professional Reports</h3>
                            <p>Beautiful PDF and CSV exports</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="card sgpa-display">
                    <div class="sgpa-label">Your Semester Grade Point Average</div>
                    <div class="sgpa-value" id="sgpaValue">0.00</div>
                    <div class="sgpa-scale">Scale: 0.00 - 10.00</div>
                    <div class="chart-container">
                        <canvas id="gradeChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-download"></i> Export Results</h2>
                    </div>
                    
                    <div class="export-actions">
                        <button class="export-btn pdf" id="exportPdf">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                        <button class="export-btn csv" id="exportCsv">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </button>
                    </div>
                </div>

                <!-- New Report Bug/Feedback Form -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-bug"></i> Report Bug / Feedback</h2>
                    </div>
                    <div class="input-group">
                        <label for="feedbackText">Describe the issue or provide feedback:</label>
                        <textarea id="feedbackText" rows="4" placeholder="e.g., Calculation error, layout issue, new feature request..."></textarea>
                    </div>
                    <button class="add-btn" id="sendFeedbackBtn">
                        <i class="fas fa-paper-plane"></i> Send Feedback
                    </button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Premium SGPA Calculator Pro &copy; 2023 | Created By Ankit Tiwari | Advanced Parsing Engine v3.0</p>
        </footer>
    </div>

    <script>
        // Disable right-click context menu
        document.addEventListener('contextmenu', event => event.preventDefault());

        // Disable common keyboard shortcuts for developer tools
        document.addEventListener('keydown', event => {
            // F12
            if (event.key === 'F12') {
                event.preventDefault();
            }
            // Ctrl+Shift+I (or Cmd+Option+I on Mac)
            if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'I') {
                event.preventDefault();
            }
            // Ctrl+Shift+J (or Cmd+Option+J on Mac)
            if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'J') {
                event.preventDefault();
            }
            // Ctrl+U (View Source)
            if ((event.ctrlKey || event.metaKey) && event.key === 'U') {
                event.preventDefault();
            }
        });


        // DOM Elements
        const themeToggle = document.getElementById('themeToggle');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const addSubjectBtn = document.getElementById('addSubject');
        const parseResultsBtn = document.getElementById('parseResults');
        const resetBtn = document.getElementById('resetBtn');
        const exportPdfBtn = document.getElementById('exportPdf');
        const exportCsvBtn = document.getElementById('exportCsv');
        const resultBody = document.getElementById('resultBody');
        const sgpaValue = document.getElementById('sgpaValue');
        const subjectNameInput = document.getElementById('subjectName');
        const creditsInput = document.getElementById('credits');
        const gradeInput = document.getElementById('grade');
        const resultText = document.getElementById('resultText');
        const parseStatus = document.getElementById('parseStatus');
        const feedbackTextarea = document.getElementById('feedbackText');
        const sendFeedbackBtn = document.getElementById('sendFeedbackBtn');

        // Grade mapping
        const gradeMap = {
            '10': 'A+',
            '9': 'A',
            '8': 'B+',
            '7': 'B',
            '6': 'C+',
            '5': 'C',
            '4': 'D',
            '0': 'F' // Default for E/F/I
        };

        const reverseGradeMap = {
            'A+': 10,
            'A': 9,
            'B+': 8,
            'B': 7,
            'C+': 6,
            'C': 5,
            'D': 4,
            'F': 0,
            'E': 0,
            'I': 0,
            'QUALIFIED': 0, // Ensure 'Qualified' and 'Absent' map to 0 points and are excluded from SGPA
            'ABSENT': 0
        };

        // Subject data
        let subjects = [];

        // Chart.js global settings for responsive text
        Chart.defaults.font.family = 'Poppins';
        // Chart.defaults.color will be updated dynamically by updateChartColors

        // Initialize Chart
        const ctx = document.getElementById('gradeChart').getContext('2d');
        const gradeChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['A+', 'A', 'B+', 'B', 'C+', 'C', 'D', 'F'],
                datasets: [{
                    data: [0, 0, 0, 0, 0, 0, 0, 0],
                    backgroundColor: [], /* Colors set dynamically by updateChartColors */
                    borderWidth: 0,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '', /* Color set dynamically */
                            font: {
                                size: 11
                            },
                            padding: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.parsed} subjects`;
                            }
                        }
                    }
                },
                cutout: '65%'
            }
        });

        // Function to update chart colors based on theme
        function updateChartColors() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            // Set legend label color based on theme
            gradeChart.options.plugins.legend.labels.color = isDarkMode ? getComputedStyle(document.body).getPropertyValue('--text-dark') : getComputedStyle(document.body).getPropertyValue('--text-light');
            
            // Set dataset background colors based on theme
            if (isDarkMode) {
                gradeChart.data.datasets[0].backgroundColor = [
                    '#4cc9f0', '#4361ee', '#3a0ca3', '#7209b7',
                    '#f72585', '#ff6b6b', '#ff9e00', '#adb5bd'
                ];
            } else {
                // Light mode distinct colors (brighter)
                gradeChart.data.datasets[0].backgroundColor = [
                    '#1ABC9C', // Turquoise for A+
                    '#2ECC71', // Emerald Green for A
                    '#3498DB', // Peter River Blue for B+
                    '#9B59B6', // Amethyst for B
                    '#F1C40F', // Sunflower Yellow for C+
                    '#E67E22', // Carrot Orange for C
                    '#E74C3C', // Alizarin Red for D
                    '#BDC3C7'  // Silver for F
                ];
            }
            gradeChart.update();
        }

        // Theme Toggle
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', 
                document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            updateChartColors(); // Update chart colors when theme changes
            updateSGPA(); // Recalculate SGPA display color if needed
        });

        // Tab Switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show corresponding content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.classList.contains(tabName)) {
                        content.classList.add('active');
                    }
                });
                
                // Auto-reset when switching tabs: Clear data and UI
                subjects = []; 
                renderSubjects();
                updateSGPA();
                updateChart();
                
                parseStatus.style.display = 'none'; // Hide status bar
                subjectNameInput.value = '';
                creditsInput.value = '4';
                gradeInput.value = '10';
                resultText.value = ''; // Clear paste textarea
            });
        });

        // Add Subject
        addSubjectBtn.addEventListener('click', () => {
            const name = subjectNameInput.value.trim();
            const credits = parseInt(creditsInput.value);
            const grade = parseInt(gradeInput.value);
            
            if (!name || isNaN(credits) || isNaN(grade) || credits <= 0) {
                showStatus('Please fill all fields correctly with valid credits.', true);
                return;
            }
            
            subjects.push({ 
                name, 
                credits, 
                grade,
                code: name.substring(0, 10).toUpperCase() // Generate simple code
            });
            
            renderSubjects();
            updateSGPA();
            updateChart();
            
            // Clear inputs
            subjectNameInput.value = '';
            creditsInput.value = '4';
            gradeInput.value = '10';
            
            showStatus('Subject added successfully!', false); // Show success status
        });

        // Function to strip HTML tags from a string (moved for scope)
        function stripHtmlTags(htmlString) {
            const doc = new DOMParser().parseFromString(htmlString, 'text/html');
            return doc.body.textContent || "";
        }

        // Helper function to parse a collected block of lines into a subject object (adapted for test.html)
        function parseSubjectBlock(blockLines, subjectCodePattern, numberPattern, gradePattern) {
            let subject = { code: '', name: '', credits: 0, grade: undefined }; // grade can be undefined initially
            let nameParts = [];
            let numericParts = []; // To collect all numbers encountered
            let foundGradeText = ''; // Store the grade text (e.g., "A+", "QUALIFIED")

            // The first line must be the subject code
            const codeMatch = subjectCodePattern.exec(blockLines[0]);
            if (!codeMatch) return null; // Invalid block start
            subject.code = codeMatch[1];

            // Iterate through the rest of the lines to extract components
            for (let i = 1; i < blockLines.length; i++) {
                const line = blockLines[i].trim();
                if (line === "") continue;

                // Check if it's a grade
                const gradeMatch = gradePattern.exec(line);
                if (gradeMatch) {
                    foundGradeText = gradeMatch[1].toUpperCase(); // Capture the grade text
                    break; // Stop processing further lines for this subject's core data
                }

                // Check if it's a number (marks or credits)
                const numMatch = numberPattern.exec(line);
                if (numMatch) {
                    numericParts.push(parseFloat(numMatch[0]));
                    continue;
                }

                // If it's not a grade, not a number, and not a new subject code or footer keyword, it's part of the name
                // Adding additional checks to filter out irrelevant lines that might appear within subject blocks
                if (!subjectCodePattern.test(line) && !line.includes("Disclaimer") && !line.includes("University") && !line.includes("Helpline") && !line.includes("Report a Bug")) {
                    nameParts.push(line);
                }
            }

            subject.name = nameParts.join(' ').trim();
            subject.grade = reverseGradeMap[foundGradeText]; // Map grade text to grade point
            
            // Determine credits: It's the last number found in the numeric parts collected before the grade
            if (numericParts.length > 0) {
                subject.credits = numericParts[numericParts.length - 1];
            } else {
                subject.credits = 0; // Default to 0 if no credits found
            }

            // Final check to ensure we have valid data
            if (subject.code && !isNaN(subject.credits) && subject.credits > 0 && subject.grade !== undefined) { // Check grade is defined after mapping
                return subject;
            }
            return null; // Not a complete valid subject
        }

        // Main parsing function with robust logic (replaces existing parseResultSheet)
        function parseResultSheet(text) {
            let rawText = text.trim();
            if (rawText.includes('<') && rawText.includes('>')) {
                rawText = stripHtmlTags(rawText);
            }

            const lines = rawText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            let parsedSubjects = [];

            // Regex patterns for parsing (defined within this scope for clarity)
            const subjectCodePattern = /^(\d{2}[A-Z]{3}-\d{3,4})$/i; // Matches "23CSH-205"
            const numberPattern = /^\d+(\.\d+)?$/; // Matches numbers like "49.84", "4", "4.00"
            const gradePattern = /^([A-Z]+[+]?|Qualified|Absent|E|F|I)$/i; // Matches grades

            // Keywords that signal the end of subject data section
            const endOfSubjectsKeywords = ["Disclaimer:", "University is not responsible", "General Helpline No:", "Email Id:", "Report a Bug", "Chandigarh University, Gharuan, Mohali (Punjab)"];

            let currentBlockLines = [];
            let isInsideSubjectBlock = false;

            for (let i = 0; i < lines.length; i++) {
                const trimmedLine = lines[i].trim();
                if (trimmedLine === "") continue;

                const lowerCaseLine = trimmedLine.toLowerCase();
                const isEndOfSubjectsSection = endOfSubjectsKeywords.some(keyword => lowerCaseLine.includes(keyword.toLowerCase()));

                if (isEndOfSubjectsSection) {
                    if (isInsideSubjectBlock && currentBlockLines.length > 0) {
                        const subject = parseSubjectBlock(currentBlockLines, subjectCodePattern, numberPattern, gradePattern);
                        if (subject) parsedSubjects.push(subject);
                    }
                    isInsideSubjectBlock = false;
                    currentBlockLines = [];
                    continue;
                }

                // Check for single-line subject format first
                // Group 1: code, Group 2: name, Group 3: credits, Group 4: grade
                // This regex is more flexible about marks by allowing zero or more (?:(?:\d+\.\d+|\s*)\s+){0,2}(\d+\.\d+)\s+([A-Z]+[+]?|Qualified|Absent|E|F|I)$
                const singleLineSubjectRegex = /^(\d{2}[A-Z]{3}-\d{3,4})\s+(.+?)\s+(?:(?:\d+\.\d+|\s*)\s+){0,2}(\d+\.\d+)\s+([A-Z]+[+]?|Qualified|Absent|E|F|I)$/i;
                const singleLineMatch = singleLineSubjectRegex.exec(trimmedLine);
                if (singleLineMatch) {
                    const gradeText = singleLineMatch[4].toUpperCase();
                    parsedSubjects.push({
                        code: singleLineMatch[1],
                        name: singleLineMatch[2].trim(),
                        credits: parseFloat(singleLineMatch[3]),
                        grade: reverseGradeMap[gradeText] // Convert grade text to grade point
                    });
                    isInsideSubjectBlock = false; // Reset block accumulation
                    currentBlockLines = [];
                    continue;
                }

                // --- Multi-line Subject Parsing Logic ---
                if (subjectCodePattern.test(trimmedLine)) {
                    // If a new subject block starts, parse the previous one if exists
                    if (isInsideSubjectBlock && currentBlockLines.length > 0) {
                        const subject = parseSubjectBlock(currentBlockLines, subjectCodePattern, numberPattern, gradePattern);
                        if (subject) parsedSubjects.push(subject);
                    }
                    currentBlockLines = [trimmedLine]; // Start a new block
                    isInsideSubjectBlock = true;
                } else if (isInsideSubjectBlock) {
                    // Continue accumulating lines for the current subject block
                    currentBlockLines.push(trimmedLine);
                }
                // Lines not part of a subject block or student info are ignored if not starting a new block
            }

            // After loop, parse any remaining accumulated block
            if (isInsideSubjectBlock && currentBlockLines.length > 0) {
                const subject = parseSubjectBlock(currentBlockLines, subjectCodePattern, numberPattern, gradePattern);
                if (subject) parsedSubjects.push(subject);
            }
            return parsedSubjects;
        }

        // Parse Results event listener remains the same, but it now calls the new parseResultSheet
        parseResultsBtn.addEventListener('click', () => {
            const text = resultText.value.trim();
            if (!text) {
                showStatus('Please paste your result sheet', true);
                // Hide processing message if input is empty
                parseStatus.style.display = 'none';
                return;
            }
            
            parseStatus.style.display = 'flex';
            parseStatus.classList.remove('error');
            parseStatus.innerHTML = '<i class="fas fa-sync fa-spin"></i> Processing your results...';
            
            setTimeout(() => {
                try {
                    const parsedSubjects = parseResultSheet(text);
                    if (parsedSubjects.length === 0) {
                        showStatus('No valid subjects found. Check your format.', true);
                        // Hide processing message after error
                        parseStatus.style.display = 'none';
                        return;
                    }
                    
                    subjects = parsedSubjects;
                    renderSubjects();
                    updateSGPA();
                    updateChart();
                    
                    showStatus(`Successfully parsed ${parsedSubjects.length} subjects!`, false);
                    
                    // Clear text after successful parse
                    resultText.value = ''; 
                    
                } catch (error) {
                    showStatus(`Error: ${error.message}`, true);
                    console.error("Parsing error:", error); // Log the error for debugging
                    // Hide processing message after error
                    parseStatus.style.display = 'none';
                }
            }, 100);
        });

        // Reset Data
        resetBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset all data?')) {
                subjects = [];
                renderSubjects();
                updateSGPA();
                updateChart();
                parseStatus.style.display = 'none'; // Hide status bar after reset
                showStatus('All data reset successfully!', false);
            }
        });

        // Export PDF
        exportPdfBtn.addEventListener('click', async () => {
            if (subjects.length === 0) {
                showStatus('No data to export', true);
                return;
            }
            
            try {
                // Create a new PDF document
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add header
                doc.setFontSize(22);
                doc.setTextColor(67, 97, 238);
                doc.text('SGPA Report', 105, 20, null, null, 'center');
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text('Generated by SGPA Calculator Pro', 105, 28, null, null, 'center');
                
                // Add current date and SGPA
                const now = new Date();
                const sgpa = calculateSGPA();
                doc.setFontSize(14);
                // Adjust text color for PDF based on overall theme, or keep consistent neutral
                doc.setTextColor(getComputedStyle(document.body).getPropertyValue('--text-light') === '#333333' ? 0 : 255); /* Use black for light mode, white for dark */

                doc.text(`Date: ${now.toLocaleDateString()}`, 15, 40);
                doc.text(`SGPA: ${sgpa.toFixed(2)}`, 15, 50);
                
                // Create table
                const headers = [['Subject Code', 'Subject Name', 'Credits', 'Grade', 'Points']];
                
                // Filter subjects to only include those with valid grades and credits for display in PDF
                const data = subjects.filter(s => s.grade !== undefined && (s.grade !== reverseGradeMap['QUALIFIED'] && s.grade !== reverseGradeMap['ABSENT'])) 
                                .map(subject => [
                    subject.code,
                    subject.name,
                    subject.credits.toString(),
                    gradeMap[subject.grade], // Use gradeMap to convert back to A+, B+ etc. for display
                    subject.grade.toString()
                ]);
                
                // Add table to PDF
                doc.autoTable({
                    startY: 60,
                    head: headers,
                    body: data,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [67, 97, 238],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    styles: {
                        cellPadding: 3,
                        fontSize: 10,
                        valign: 'middle',
                        textColor: getComputedStyle(document.body).getPropertyValue('--text-light') === '#333333' ? 0 : 255 // Table cell text color
                    },
                    margin: { top: 10 }
                });
                
                // Add footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Page ${i} of ${pageCount}`, 105, 287, null, null, 'center');
                }
                
                // Save the PDF
                doc.save(`SGPA_Report_${now.getTime()}.pdf`);
                showStatus('PDF exported successfully!', false);
            } catch (error) {
                showStatus('Failed to generate PDF: ' + error.message, true);
                console.error("PDF export error:", error);
            }
        });

        // Export CSV
        exportCsvBtn.addEventListener('click', () => {
            if (subjects.length === 0) {
                showStatus('No data to export', true);
                return;
            }
            
            try {
                // Create CSV content
                let csv = 'Subject Code,Subject Name,Credits,Grade,Points\n';
                
                // Filter subjects for CSV export as well
                subjects.filter(s => s.grade !== undefined && (s.grade !== reverseGradeMap['QUALIFIED'] && s.grade !== reverseGradeMap['ABSENT']))
                         .forEach(subject => {
                    csv += `"${subject.code}","${subject.name}",${subject.credits},"${gradeMap[subject.grade]}",${subject.grade}\n`;
                });
                
                // Add SGPA
                const sgpa = calculateSGPA();
                csv += `\nSGPA,,,${sgpa.toFixed(2)}\n`; // Added a newline for better formatting in CSV
                
                // Create download link
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `sgpa_report_${new Date().getTime()}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showStatus('CSV exported successfully!', false);
            } catch (error) {
                showStatus('Failed to generate CSV: ' + error.message, true);
                console.error("CSV export error:", error);
            }
        });

        // Delete Subject
        function deleteSubject(index) {
            subjects.splice(index, 1);
            renderSubjects();
            updateSGPA();
            updateChart();
            showStatus('Subject deleted.', false); // Add status message
        }

        // Render Subjects
        function renderSubjects() {
            resultBody.innerHTML = '';
            
            if (subjects.length === 0) {
                resultBody.innerHTML = `
                    <tr class="empty-state">
                        <td colspan="5">
                            <i class="fas fa-inbox"></i>
                            <p>No subjects added yet</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            subjects.forEach((subject, index) => {
                const row = document.createElement('tr');
                // Apply a different style for 'Qualified'/'Absent' subjects if needed for visual distinction
                const isExcluded = (subject.grade === reverseGradeMap['QUALIFIED'] || subject.grade === reverseGradeMap['ABSENT']);
                row.classList.toggle('bg-gray-100', isExcluded);
                row.classList.toggle('text-gray-500', isExcluded);
                row.classList.toggle('italic', isExcluded);
                row.innerHTML = `
                    <td>
                        <div><strong>${subject.code}</strong></div>
                        <div style="font-size: 0.9em; opacity: 0.8;">${subject.name}</div>
                    </td>
                    <td>${subject.credits}</td>
                    <td>${gradeMap[subject.grade] || (isExcluded ? (subject.grade === reverseGradeMap['QUALIFIED'] ? 'Qualified' : 'Absent') : 'N/A')}</td> <!-- Display actual grade text or N/A -->
                    <td>${subject.grade !== undefined ? subject.grade : 'N/A'}</td>
                    <td class="actions">
                        <button class="action-btn" title="Delete" onclick="deleteSubject(${index})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                resultBody.appendChild(row);
            });
        }

        // Calculate SGPA
        function calculateSGPA() {
            if (subjects.length === 0) return 0;
            
            let totalCredits = 0;
            let totalPoints = 0;
            
            // Only include subjects with valid grade points (not Qualified/Absent) and positive credits
            subjects.forEach(subject => {
                if (subject.grade !== undefined && subject.grade !== null && !isNaN(subject.credits) && subject.credits > 0 && 
                    (subject.grade !== reverseGradeMap['QUALIFIED'] && subject.grade !== reverseGradeMap['ABSENT'])) { // Explicitly exclude Qualified/Absent
                    totalCredits += subject.credits;
                    totalPoints += subject.credits * subject.grade;
                }
            });
            
            if (totalCredits === 0) return 0; // Avoid division by zero
            
            return (totalPoints / totalCredits);
        }

        // Update SGPA Display
        function updateSGPA() {
            const sgpa = calculateSGPA();
            sgpaValue.textContent = sgpa.toFixed(2);
            
            // Add animation
            sgpaValue.classList.add('highlight');
            setTimeout(() => sgpaValue.classList.remove('highlight'), 2000);
            
            // Update SGPA display color based on performance and theme
            const isDarkMode = document.body.classList.contains('dark-mode');
            if (isDarkMode) {
                if (sgpa >= 9.0) {
                    sgpaValue.style.color = '#4cc9f0';
                } else if (sgpa >= 8.0) {
                    sgpaValue.style.color = '#4361ee';
                } else if (sgpa >= 7.0) {
                    sgpaValue.style.color = '#7209b7';
                } else if (sgpa >= 6.0) {
                    sgpaValue.style.color = '#f72585';
                } else {
                    sgpaValue.style.color = '#ff6b6b';
                }
            } else {
                // Use var(--text-dark) for light mode SGPA value for better contrast
                sgpaValue.style.color = getComputedStyle(document.body).getPropertyValue('--text-dark');
            }
        }


        // Update Chart
        function updateChart() {
            // Count grades
            const gradeCount = {
                'A+': 0, 'A': 0, 'B+': 0, 'B': 0,
                'C+': 0, 'C': 0, 'D': 0, 'F': 0
            };
            
            // Only count grades for subjects included in SGPA calculation
            subjects.forEach(subject => {
                if (subject.grade !== undefined && subject.grade !== null && !isNaN(subject.credits) && subject.credits > 0 &&
                    (subject.grade !== reverseGradeMap['QUALIFIED'] && subject.grade !== reverseGradeMap['ABSENT'])) {
                    const grade = gradeMap[subject.grade];
                    if (gradeCount.hasOwnProperty(grade)) {
                        gradeCount[grade]++;
                    }
                }
            });
            
            // Update chart data
            gradeChart.data.datasets[0].data = [
                gradeCount['A+'], gradeCount['A'], gradeCount['B+'], gradeCount['B'],
                gradeCount['C+'], gradeCount['C'], gradeCount['D'], gradeCount['F']
            ];
            
            updateChartColors(); // Ensure correct colors are applied after data update
            gradeChart.update();
        }

        // Save data to localStorage (now only for theme, not subject data)
        function saveData() {
            localStorage.setItem('sgpaTheme', 
                document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }

        // Load data from localStorage (now only for theme)
        function loadData() {
            const savedTheme = localStorage.getItem('sgpaTheme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode'); // Ensure light mode is default or explicitly set
            }
        }

        // Function to show status messages
        function showStatus(message, isError) {
            parseStatus.style.display = 'flex';
            parseStatus.classList.toggle('error', isError);
            parseStatus.innerHTML = `<i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i> <span>${message}</span>`;
            // Automatically hide after a few seconds unless it's an error
            if (!isError) {
                setTimeout(() => {
                    parseStatus.style.display = 'none';
                }, 3000);
            }
        }

        // Initialize
        function init() {
            // Clear localStorage for subject data and pre-filled text on every init (page load) to ensure auto-reset
            localStorage.removeItem('sgpaData'); 
            resultText.value = ''; // Clear textarea on refresh

            loadData(); // Load theme
            subjects = []; // Explicitly reset subjects array
            renderSubjects();
            updateSGPA();
            updateChart();
            updateChartColors(); // Initial chart color update
        }

        // Initialize the application
        init();

        // Send Feedback/Bug Report
        sendFeedbackBtn.addEventListener('click', () => {
            const feedback = feedbackTextarea.value.trim();
            if (feedback) {
                const subject = encodeURIComponent("SGPA Calculator Pro Feedback/Bug Report");
                const body = encodeURIComponent(feedback);
                window.location.href = `mailto:futureengineer9915@gmail.com?subject=${subject}&body=${body}`;
                feedbackTextarea.value = ''; // Clear the textarea after sending
            } else {
                showStatus('Please enter your feedback or bug description.', true);
            }
        });
    </script>
</body>
</html>
